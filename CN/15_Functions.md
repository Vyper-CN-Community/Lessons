# 使用 def 关键字在 Vyper 中定义函数

在 Vyper 中，使用 `public` 关键字声明状态变量（例如 `my_favorite_number: public(uint256)`）会自动创建一个 Getter 函数。这允许任何人读取变量的当前值（在此例中初始化为 0，或其默认值）。然而，一个常见的挑战出现了：**合约部署后，你如何修改或更新这个值？** 仅仅读取变量并不会改变合约的状态。

解决方案在于在智能合约中定义**函数**（有时称为方法）。函数是独立的逻辑块，设计用于在被调用时执行特定任务。如果你熟悉 Python 或 JavaScript 等语言，Vyper 中的函数概念会让你感到亲切。它们对于添加改变合约数据的逻辑至关重要。

### 使用 def 定义函数

在 Vyper 中，函数使用 `def` 关键字定义，代表 'definition'。基本语法涉及几个关键组件：

1.  **def 关键字**：标志着函数定义的开始。
2.  **函数名**：紧跟 `def` 之后，为你的函数命名（例如 `store`）。
3.  **圆括号 ()**：跟在函数名之后。这些括号包含了函数的输入参数。
4.  **参数 (Inputs)**：在括号内使用 `parameter_name: type` 语法定义。参数允许你向函数传递数据。例如，`new_number: uint256` 定义了一个名为 `new_number` 的输入，它必须是一个无符号 256 位整数。
5.  **冒号 :**：出现在参数列表的闭括号之后，标志着函数代码块的开始。
6.  **缩进**：Vyper 是**缩进敏感**的（像 Python 一样）。属于该函数的代码行必须相对于 `def` 行进行缩进（通常是 4 个空格）。此缩进定义了函数的范围或主体。
7.  **函数体**：包含函数在被调用时执行的逻辑的缩进代码块。

### 访问状态变量：self 关键字

在函数内部使用状态变量时，一个至关重要的概念是 `self` 关键字。要访问或修改在合约级别声明的变量（像 `my_favorite_number` 这样的状态变量），你必须在它们前面加上 `self.` 前缀。

例如，要将 `new_number` 参数的值赋给 `my_favorite_number` 状态变量，你会写：

```vyper
self.my_favorite_number = new_number
```

`self` 关键字指的是合约的当前实例。它明确告诉 Vyper 编译器，你打算与合约的存储（`my_favorite_number` 状态变量）进行交互，而不是（例如）创建一个仅在函数范围内有效的名为 `my_favorite_number` 的新局部变量。在尝试修改状态变量时省略 `self.` 会导致错误或意外行为。

### 函数可见性：@external 装饰器

就像状态变量有 `public` 这样的可见性修饰符一样，函数也有可见性控制，决定了它们可以从哪里被调用。默认情况下，Vyper 函数是 **internal** 的，这意味着它们只能从同一个合约或继承它的合约内部调用。

要允许函数从合约**外部**被调用（例如，由用户通过接口发送交易，或由另一个独立的合约调用），你必须使用 `@external` 装饰器。装饰器由 `@` 符号表示，用于修改紧随其后定义的函数或类的行为。

`@external` 装饰器放置在 `def` 语句正上方的行：

```vyper
@external
def store(new_number: uint256):
    self.my_favorite_number = new_number
```

### 融会贯通：一个例子

让我们结合这些概念来创建一个更新 `my_favorite_number` 状态变量的函数：

```vyper
my_favorite_number: public(uint256)

@external
def store(new_number: uint256):
    self.my_favorite_number = new_number
```

### 交互与状态更改：交易

当你编译并部署像上面这样的合约（例如，在 Remix IDE 中）时，你与它的交互方式会根据你是读取还是写入状态而有所不同：

*   **读取 (my_favorite_number)**：因为变量是 `public` 的，所以创建了一个自动 Getter 函数。调用此 Getter（在 Remix 中通常由**蓝色按钮**表示）只是从区块链状态读取当前值。这是一个**只读**操作，不需要发送交易或支付 Gas（除了潜在的节点提供商费用）。
*   **写入 (store 函数)**：因为 `store` 函数被标记为 `@external`，所以它可以从外部调用。调用此函数涉及提供 `new_number` 输入。至关重要的是，因为此函数修改了合约的状态 (`self.my_favorite_number = new_number`)，执行它需要向区块链**发送交易**。此交易必须被挖掘，消耗 Gas，并永久记录状态更改。在 Remix 中，这通常由**橙色按钮**表示。

### 关键要点

*   使用 `def` 关键字在 Vyper 中定义函数。
*   函数是实现修改智能合约状态逻辑所必需的。
*   在函数内部使用 `self.` 前缀来访问或修改合约级状态变量。
*   使用可见性装饰器如 `@external`（用于外部调用）控制函数的可访问性，或依赖默认的 internal。
*   Vyper 是**缩进敏感**的；正确的缩进对于定义函数体范围至关重要。
*   调用修改合约状态的函数需要向区块链发送交易，而读取公共状态变量通常不需要。
